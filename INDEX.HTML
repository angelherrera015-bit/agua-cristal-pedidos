<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGUA CRISTAL ZONA 6 - Pedidos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --color-primary: #06b6d4;
            --color-secondary: #0891b2;
            --color-light: #f0fdfa;
            --color-dark: #0e7490;
        }
        .bg-water-primary { background-color: var(--color-primary); }
        .hover\:bg-water-secondary:hover { background-color: var(--color-secondary); }
        .text-water-primary { color: var(--color-primary); }
        .border-water-primary { border-color: var(--color-primary); }
        .shadow-water { box-shadow: 0 10px 15px -3px rgba(6, 182, 212, 0.5), 0 4px 6px -2px rgba(6, 182, 212, 0.05); }
        body { font-family: 'Inter', sans-serif; background-color: var(--color-light); }
        .main-button { transition: all 0.3s ease; transform: scale(1); }
        .main-button:hover { transform: scale(1.03); box-shadow: 0 20px 25px -5px rgba(6, 182, 212, 0.4); }
    </style>
</head>
<body class="min-h-screen flex flex-col antialiased">
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let app, db, auth;
        let userId = 'anon';
        let userRole = null;
        let currentView = 'login';
        let dailySales = 0;
        let todayOrders = [];
        let isFirestoreAvailable = true; 

        // CONFIGURACIÓN DE PRECIOS
        const PRECIOS = {
            'NORMAL_DOMICILIO': 11.00,
            'NORMAL_TIENDA': 9.00,
            'PEQUENA': 1.00,
            'MEDIA': 3.00
        };

        const LOGO_URL = "https://r.jina.ai/i/69599a09325941c9bc88c7f39589d71c";

        const CREDENTIALS = {
            'ADMINISTRADOR': 'Angel2006$',
            'USUARIO 1': 'Aguacristal06'
        };

        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyAlrX-AEX7P-Ntpg30_62YHbL6Z3zxykDQ",
            authDomain: "aguacristal-3668c.firebaseapp.com",
            projectId: "aguacristal-3668c",
            storageBucket: "aguacristal-3668c.firebasestorage.app",
            messagingSenderId: "777148704166",
            appId: "1:777148704166:web:c522eaac1d469ac0829b67"
        };
        
        const COLLECTION_PATH = `orders_ACZ6`;
        const getTodayDate = () => new Date().toISOString().slice(0, 10);

        window.initFirebase = async () => {
            try {
                app = initializeApp(FIREBASE_CONFIG);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, async (user) => {
                    if (!user) await signInAnonymously(auth);
                });
                window.setupRealtimeListener();
                window.renderApp();
            } catch (error) {
                console.error("Firebase Error:", error);
                isFirestoreAvailable = false; 
                window.renderApp('login'); 
            }
        };

        window.renderApp = (newView = currentView) => {
            currentView = newView;
            const appContainer = document.getElementById('app-container');
            const isAdmin = userRole === 'ADMINISTRADOR';
            appContainer.innerHTML = '';

            if (!userRole) appContainer.innerHTML = window.renderLogin();
            else if (currentView === 'home') appContainer.innerHTML = window.renderHome();
            else if (currentView === 'form') appContainer.innerHTML = window.renderOrderForm();
            else if (currentView === 'orders') appContainer.innerHTML = window.renderOrdersList(isAdmin);

            lucide.createIcons();
            window.attachEventListeners();
        };

        window.renderLogin = () => `
            <div class="p-8 max-w-sm mx-auto my-16 bg-white rounded-xl shadow-water border-4 border-water-primary text-center">
                <img src="${LOGO_URL}" alt="Logo" class="w-32 mx-auto mb-4">
                <h1 class="text-2xl font-extrabold mb-4 text-water-primary">AGUA CRISTAL ZONA 6</h1>
                <div id="login-error" class="text-red-600 text-sm mb-4 hidden"></div>
                <input type="text" id="username" class="w-full px-3 py-2 border rounded-md mb-3" placeholder="Usuario">
                <input type="password" id="password" class="w-full px-3 py-2 border rounded-md mb-4" placeholder="Contraseña">
                <button id="login-button" class="w-full py-2 rounded-md text-white bg-water-primary font-bold">Ingresar</button>
            </div>`;

        window.renderHome = () => `
            <header class="w-full bg-white shadow p-4 flex justify-between items-center sticky top-0 z-10">
                <div class="flex items-center"><img src="${LOGO_URL}" class="w-10 mr-2"><h1 class="font-bold text-water-dark">Hola, ${userRole}</h1></div>
                <div class="flex space-x-2">
                    <button id="view-orders-button" class="px-3 py-2 text-xs font-medium rounded-full bg-cyan-100 text-water-dark">Pedidos</button>
                    <button id="logout-button" class="px-3 py-2 text-xs font-medium rounded-full bg-red-100 text-red-700">Salir</button>
                </div>
            </header>
            <div class="flex-grow flex flex-col justify-center items-center p-6 space-y-8 max-w-4xl mx-auto">
                <h2 class="text-3xl font-extrabold text-gray-800 text-center">Nuevo Pedido</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full">
                    <button id="order-domicilio" class="main-button p-8 bg-white rounded-2xl shadow-water border-2 border-water-primary flex flex-col items-center">
                        <i data-lucide="truck" class="w-12 h-12 mb-2 text-water-primary"></i>
                        <span class="text-xl font-bold uppercase">A Domicilio</span>
                        <span class="text-xs text-gray-500 text-center">Normal Q.${PRECIOS.NORMAL_DOMICILIO.toFixed(2)}</span>
                    </button>
                    <button id="order-fisica" class="main-button p-8 bg-white rounded-2xl shadow-water border-2 border-water-primary flex flex-col items-center">
                        <i data-lucide="store" class="w-12 h-12 mb-2 text-water-primary"></i>
                        <span class="text-xl font-bold uppercase">En Tienda</span>
                        <span class="text-xs text-gray-500 text-center">Normal Q.${PRECIOS.NORMAL_TIENDA.toFixed(2)}</span>
                    </button>
                </div>
            </div>`;

        window.renderOrderForm = () => {
            const type = localStorage.getItem('currentOrderType');
            const isDomicilio = type === 'A DOMICILIO';
            return `
                <div class="p-6 max-w-2xl mx-auto my-8 bg-white rounded-xl shadow-lg border-t-8 border-water-primary">
                    <button id="back-home-button" class="mb-4 text-gray-500 flex items-center"><i data-lucide="chevron-left" class="w-4 h-4 mr-1"></i> Volver</button>
                    <h3 class="text-2xl font-extrabold text-water-dark mb-6">PEDIDO: ${type}</h3>
                    <form id="order-form" class="space-y-4">
                        <input type="text" id="customerName" required placeholder="Nombre del Cliente" class="w-full px-4 py-2 border rounded-lg">
                        <input type="tel" id="phone" required placeholder="Teléfono" class="w-full px-4 py-2 border rounded-lg">
                        
                        <div class="p-4 bg-gray-50 rounded-lg space-y-3">
                            <p class="font-bold text-sm text-gray-600 uppercase">Productos:</p>
                            
                            <div class="flex items-center justify-between">
                                <label class="text-sm">Garrafón Normal</label>
                                <input type="number" id="qty_normal" min="0" value="0" class="product-qty w-20 px-2 py-1 border rounded text-center">
                            </div>
                            <div class="flex items-center justify-between">
                                <label class="text-sm">Garrafón Pequeño (Q.1)</label>
                                <input type="number" id="qty_pequena" min="0" value="0" class="product-qty w-20 px-2 py-1 border rounded text-center">
                            </div>
                            <div class="flex items-center justify-between">
                                <label class="text-sm">1/2 Garrafón (Q.3)</label>
                                <input type="number" id="qty_media" min="0" value="0" class="product-qty w-20 px-2 py-1 border rounded text-center">
                            </div>
                        </div>

                        <div class="flex-1 p-3 bg-cyan-100 rounded-lg text-center font-bold text-xl text-water-dark" id="total-display">TOTAL: Q.0.00</div>
                        
                        <input type="text" id="nit" placeholder="NIT (C/F)" class="w-full px-4 py-2 border rounded-lg">
                        <textarea id="address" rows="3" placeholder="Dirección de Entrega" class="${isDomicilio ? '' : 'hidden'} w-full px-4 py-2 border rounded-lg"></textarea>
                        
                        <button type="submit" class="w-full py-3 rounded-lg text-white bg-water-primary font-bold shadow-lg">REGISTRAR PEDIDO</button>
                    </form>
                    <div id="form-message" class="mt-4 p-3 rounded-lg text-center hidden font-bold"></div>
                </div>`;
        };

        window.renderOrdersList